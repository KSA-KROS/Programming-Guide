### KROS Robot Programming Guide
# 2. 빌드

## A. Introduction

Android Studio에서 프로젝트를 바로 빌드하면 FTC Robot Controller가 빌드되어 실행된다. 하지만 이 프로그램은 실질적으로 로봇을 구동시키는 앱으로, 
Expansion Hub에 직접 연결해서 사용하는 형식이며, 로봇의 CPU 역할을 핸드폰이 수행하도록 할 때 사용하는 기능이다.
우리는 Control Hub를 사용하여 로봇을 제작하고 있으며, Control 허브를 사용하는 것이 안정성 측면에서 유리한 점이 높으므로, Control Hub에 제작한 코드를 입력하여 빌드하는 방법을 소개하고자 한다.

## B. REV Hardware Client

**REV Hardware Client**라는 프로그램을 활용하여 Control Hub에 코드를 입력하고, 빌드를 수행할 수 있다.
> 설치 사이트 : https://docs.revrobotics.com/rev-hardware-client/gs/install    
> 만약 설치 사이트가 변경 되었다면 수정 부탁      
> exe 파일만 존재하기에, MacOS 환경에서는 가상 머신으로 Windows를 구동하여 실행할 수 있다.    

REV Hardware Client는 Control Hub에 코드를 삽입하고, 구동을 위한 관련 프로그램 및 APK, 펌웨어 설치 등을 관리해주는 프로그램이다.

Control Hub에 전원을 연결하고, 장치의 LED가 파란색에서 초록색으로 바뀌면, **KROS-ControlHub**라는 이름의 Wifi가 뜰 것이다.
이 Wifi에 접속하면 Control Hub와 직접 통신이 가능하며, REV Hardware Client의 Hardware탭에 Control Hub가 뜰 것이다. (인터넷은 연결되지 않기에, Wifi를 수시로 바꿔야한다.)

Control Hub에서 할 수 있는 일
* Control Hub 내부 OS 및 펌웨어를 업데이트 (단, Downloads 탭에서 관련 프로그램을 미리 인터넷에 연결된 상태로 다운로드 해놓아야 한다.)
* 코드 삽입 및 빌드
* 네트워크 설정 변경 (Wifi 이름, 비밀번호 등)

우리는 Control Hub의 OnBotJava 탭에 코드를 입력하고, 빌드하여 Control Hub에 소스코드를 이식할 수 있다.

## C. Source Code Upload

**Control Hub의 OnBotJava 탭에서 소스코드를 업로드 할 수 있다.**

OnBotJava 탭에 들어가면 왼쪽에 보이는 탐색기가 보일것이다. 이곳에 Android Studio로 프로그래밍한 코드를 업로드 하면 된다.
만약 전 대회 혹은 불필요한 소스코드가 남아있다면, 파일을 선택하고 삭제 버튼을 누르거나, 폴더를 삭제하여 한꺼번에 지울 수 있다.
폴더는 `org.firstinspires.ftc.teamcode`의 이름으로 되어있을텐데, JAVA를 아는 사람은 알겠지만, 이것은 디렉토리 경로를 의미한다.
따라서 이 상태에서 삭제를 하면 `teamcode 폴더`가 삭제되어 `org.firstinspires.ftc`가 될 것이고, 여기에 `teamcode`라는 이름의 폴더를 생성하여 새로운 소스코드를 통째로 업로드하면 된다.

## D. FTC Driver Station

로봇을 구동시키기 위해서는 Control Hub와 **FTC Driver Station 앱을 실행중인 안드로이드 기기**가 통신을 주고 받아야 한다.

FTC Driver Station은 로봇의 Op 모드를 선택하고, 구동을 컨트롤하며, Telemetry를 활용한 Log를 확인할 수 있도록 해준다.
또한, GamePad를 연결하여 로봇 조작을 가능하게 하고, 로봇의 배터리 양을 알려주는 역할을 수행한다. 
(로봇의 배터리는 % 수치로 알려주지 않고, 배터리 전압값으로 알려준다. 전압이 낮으면 부품들이 제대로 동작하지 않을 수 있기에, 충전을 해주어야 한다.)

FTC Driver Station APK는 REV Hardware Client의 Downloads에서 다운로드 받을 수 있다.
Driver Station App을 다운로드하여 Browse Downloaded Files 버튼을 누르면 apk 파일을 찾을 수 있고, 이를 안드로이드 기기에 전송하여 APK 파일을 실행시키면 설치 가능하다.

단, APK 파일은 보안 문제로 최근 대부분의 안드로이드 기기에서 설치를 막는 경우가 존재한다. 안전한 프로그램이니 걱정하지 않고 설치해도 되며, 설치가 되지 않을 경우 구글링을 해보길 바란다.

FTC Driver Station을 설치한 이후, 안드로이드 기기를 **KROS-ControlHub** Wifi에 연결하면 통신이 가능하다. (Control Hub에 전원을 연결해야함)
하지만 이런다고 바로 통신이 되지는 않을 것이다. 우리는 Control Hub와 통신하는 것이므로, FTC Driver Station의 `Settings 창`에 들어가 Pairing Method 항목값을 Wi-Fi Direct에서 Control Hub로 바꿔주어야 한다.
그러면 Control Hub와 FTC Driver Station이 서로 통신을 시작하면서 연결되었다는 표식이 뜰 것이다.

## E. Build & Run

REV Hardware Client에 소스코드를 전부 업로드하고, 우측 하단의 빌드 버튼을 누르면 빌드가 시작된다. 단, 로봇과 통신중인 상태에서만 코드 수정과 빌드가 가능하다. 

또한, FTC Driver Station에서 미리 설정해주어야 하는 부분이 존재한다. `Configure Robot 칭`에 들어가면 Device Name을 설정할 수 있는 창이 등장한다. 기존 설정은 지워버리고 이번 대회에 맞는 디바이스 설정을 추가하여 자유롭게 사용하면 된다.

New 버튼을 누르면 새로운 설정을 추가할 수 있으며, Control Hub와 연결된 모든 Expansion Hub의 Motor, Servo, Analog, Digital 등 여러 입출력 포트들에 각각 어떤 디바이스가 연결되어있고, 이들의 이름을 설정해줄 수 있다.
이 이름들은 코드에서 HardwareMap을 사용하여 하드웨어를 가져올 때 사용되는 이름이므로 매우 중요하며, 코드에 작성된 하드웨어가 해당 디바이스 설정에 존재하지 않으면 오류가 발생하기에 꼼꼼히 잘 설정해주어야 한다.
또한, 하드웨어 정보를 제공해주는 역할을 하므로, 장치들에 적힌 이름을 참고하여 정확한 디바이스 종류를 선택해주길 바란다.

모든 설정이 끝나고, 빌드까지 완료되었다면 드디어 로봇을 동작시킬 수 있다. FTC Driver Station의 Select OpMode에서 AutoOp 혹은 TeleOp를 선택할 수 있다. 자신이 제작한 Op를 선택한 후, 가운데 INIT 버튼을 누르면 구동이 시작된다.

참고로 로봇은 Init > Start > Loop > Stop의 순서대로 작동하며, Init 버튼이 눌리면 Init이 수행되고, Start 버튼이 눌리면 Start 함수를 수행한 후에, Loop 함수를 끝날 때 까지 지속하며, Stop 버튼이 눌리면 Stop 함수의 내용을 수행한다.


## Appendix
X
